++ Begin File
# Sonar-like Hotspots and Recommendations

This file summarizes the high-priority security and static-analysis hotspots identified in the repo.

## Overview
Analyzed patterns: subprocess.run with shell=True, unsafe command execution, potential secrets or long placeholders, requests to internal endpoints (for local health checks), and other high-risk patterns (eval/exec, yaml.load, pickle.load) — none of which were found in user code except for subprocess run uses.

## High Priority (Immediate attention)
- mcp_server.py - `_execute_task` (line ~1714): tasks contain command data. Running arbitrary `cmd` with subprocess should be tightly controlled. Implemented a defensive patch to normalize strings into lists and fallback to `shell=True` only when unavoidable; recommended further steps:
  - Add a `allow_shell` boolean on tasks and require server-side authorization for it.
  - Validate or whitelist commands allowed to run via controller.
  - Add unit tests to verify that string `cmd` inputs are parsed as list commands and do not run with shell unless explicitly allowed.

- run_48hour_validation.py - multiple `shell=True` fallbacks. Default config includes health checks and test commands; user-provided config may contain metacharacters that require shell usage:
  - Recommend requiring `command` to be an explicit list (JSON array) or a dict with `shell: true`/`false` to avoid auto-fallback.
  - For user-sourced configs, add validation to disallow metacharacters unless explicitly allowed and authorized in a separate admin-only config flag.

- run_phase2_complete.py - similar fallback to shell usage for complex test commands:
  - Same recommendation as above: prefer list-based invocation, enforce `shell: true` only when explicitly declared and authorized.

## Medium Priority
- scripts that append tokens or have placeholders (`setup_free_ai.sh` and `FREE_AI_SETUP.md`): replaced `your_token_here` with a short placeholder (`<YOUR_HF_TOKEN>`), and the appended `.zshrc` line is commented so it won't add a likely-flagged token value to users' shells. This addresses pre-commit false positives and prevents accidental secret inclusion.

- Check all other scripts for `export VAR=...` patterns with long placeholder strings (e.g., `MCP_AUTH_TOKEN` default) — changed server scripts to use empty defaults or not to populate token values by default.

## Low Priority
- `requests.*` to `localhost` & health checks: accepted as 'local health checks', but consider moving tests that rely on external services into integration-specific code that gets skipped in PR CI checks.

## Recommended Next Steps
1. Implement 'allow_shell' flags or configuration for controlled shell usage and require server-side admin authorization.
2. Write unit tests for command parsing behavior for `mcp_server._execute_task` and `run_48hour_validation` to ensure safe invocation.
3. Review any other `subprocess.run` occurrences where the command originates from external input and apply the same pattern: normalize to list, avoid shell=True unless authorized.
4. Add `bandit` and `ruff` rules or custom grep checks in CI to detect `subprocess.run` calls with `shell=True` that don't pass a `trusted` or `allow_shell` flag.

---
This report was generated by an automated scan in the workspace; it is a prioritized list and is conservative by design (preferring to avoid any `shell=True`).

++ End File