name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validate:
    name: PR Validation (macOS) - CodingReviewer
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show environment
        run: |
          sw_vers
          swift --version || true

      - name: Install SwiftFormat (best-effort)
        run: |
          if ! command -v swiftformat >/dev/null 2>&1; then
            brew install swiftformat || true
          fi

      - name: Run SwiftFormat lint (best-effort)
        run: |
          if command -v swiftformat >/dev/null 2>&1; then
            swiftformat --lint CodingReviewer || true
          else
            echo "swiftformat not available; skipping"
          fi

      - name: Install SwiftLint (best-effort)
        run: |
          if ! command -v swiftlint >/dev/null 2>&1; then
            brew install swiftlint || true
          fi

      - name: Run SwiftLint (best-effort)
        run: |
          if command -v swiftlint >/dev/null 2>&1; then
            (cd CodingReviewer && swiftlint) || true
          else
            echo "swiftlint not available; skipping"
          fi

      - name: Build and test project
        run: |
          set -o pipefail
          proj=$(ls *.xcodeproj 2>/dev/null | head -n1 || true)
          if [[ -n "$proj" ]]; then
            echo "Found project: $proj"
            schemes=$(xcodebuild -list -project "$proj" 2>/dev/null | sed -n '/Schemes:/,$p' | tail -n +2)
            scheme=$(echo "$schemes" | head -n1 | xargs)
            if [[ -n "$scheme" ]]; then
              echo "Using scheme: $scheme"
              xcodebuild -project "$proj" -scheme "$scheme" -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14' clean build test | tee xcodebuild.log
            else
              echo "No scheme found; skipping build/test"
            fi
          else
            echo "No .xcodeproj found; skipping build/test"
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codingreviewer-validation-logs
          path: |
            xcodebuild.log
            CodingReviewer/xcodebuild.log || true

  quantum-self-heal-run:
    name: Quantum Agent - Dry Run Self-Heal
    needs: pr-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Quantum Agent entrypoint (dry-run)
        run: |
          bash Tools/Automation/quantum_agent_entrypoint.sh Projects/CodingReviewer true false 2>&1 | tee ai_recovery_codingreviewer.log || true

      - name: Upload AI recovery log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codingreviewer-ai-recovery-log
          path: ai_recovery_codingreviewer.log
