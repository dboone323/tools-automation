---
name: "Release Automation"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  build_and_release:
    name: Build, test and prepare release
    runs-on: macos-latest
    env:
      GITHUB_REF_NAME: ${{ github.ref_name }}
      INPUT_VERSION: ${{ github.event.inputs.version || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode (if present)
        run: |
          if [ -d "/Applications/Xcode_15.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer || true
          else
            echo "Xcode 15 not found; using system default"
          fi

      - name: Build release (best-effort)
        run: |
          set -euo pipefail
          echo "ðŸ—ï¸ Building release..."
          xcodebuild -scheme HabitQuest clean build CODE_SIGNING_ALLOWED=NO || true

      - name: Run tests (best-effort)
        run: |
          set -euo pipefail
          echo "ðŸ§ª Running tests..."
          xcodebuild test CODE_SIGNING_ALLOWED=NO || true

      - name: Generate release notes
        run: |
          set -euo pipefail
          VERSION=""
          if [[ "${GITHUB_REF_NAME:-}" != "" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          fi
          if [[ -z "$VERSION" && "${INPUT_VERSION:-}" != "" ]]; then
            VERSION="${INPUT_VERSION}"
          fi
          if [[ -z "$VERSION" ]]; then
            VERSION="manual-$(date -u +%Y%m%d%H%M%S)"
          fi
          mkdir -p release_artifacts
          cat > release_artifacts/RELEASE_NOTES.md <<'RELEASE'
          # HabitQuest ${VERSION}
          Released on $(date -u +%Y-%m-%d)

          ## What's New

          ## Technical Improvements

          ## Security Updates

          **Full Changelog**: https://github.com/${{ github.repository }}
          RELEASE

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release_artifacts

      - name: Create GitHub Release (if triggered by tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tag = context.ref.replace('refs/tags/', '');
            const body = fs.readFileSync('release_artifacts/RELEASE_NOTES.md', 'utf8');
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `HabitQuest ${tag}`,
              body: body,
              draft: false,
              prerelease: false
            });
