#!/bin/bash
#
# Pre-Commit Git Hook
# Fast checks before committing (< 10 seconds target)
#
# Automatically runs:
# - SwiftLint auto-fix
# - SwiftFormat
# - Basic syntax validation
# - Spell checking
#
# To bypass: git commit --no-verify
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Running pre-commit checks...${NC}"

# Get staged Swift files
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)

if [ -z "$STAGED_SWIFT_FILES" ]; then
    echo -e "${GREEN}‚úÖ No Swift files to check${NC}"
    exit 0
fi

# SwiftLint auto-fix
if command -v swiftlint >/dev/null 2>&1; then
    echo -e "${BLUE}Running SwiftLint...${NC}"
    for file in $STAGED_SWIFT_FILES; do
        swiftlint lint --path "$file" --fix --quiet || true
        # Re-stage file if modified
        git add "$file"
    done
    echo -e "${GREEN}‚úÖ SwiftLint complete${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  SwiftLint not installed - skipping${NC}"
fi

# SwiftFormat
if command -v swiftformat >/dev/null 2>&1; then
    echo -e "${BLUE}Running SwiftFormat...${NC}"
    for file in $STAGED_SWIFT_FILES; do
        swiftformat "$file" --quiet
        # Re-stage file if modified
        git add "$file"
    done
    echo -e "${GREEN}‚úÖ SwiftFormat complete${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  SwiftFormat not installed - skipping${NC}"
fi

# Basic syntax check (fast)
echo -e "${BLUE}Checking syntax...${NC}"
for file in $STAGED_SWIFT_FILES; do
    if ! xcrun swiftc -parse "$file" >/dev/null 2>&1; then
        echo -e "${RED}‚ùå Syntax error in: $file${NC}"
        exit 1
    fi
done
echo -e "${GREEN}‚úÖ Syntax check passed${NC}"

echo -e "${GREEN}‚úÖ Pre-commit checks complete!${NC}"
exit 0
