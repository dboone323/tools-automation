# Deployment Pipeline for MomentumFinance
# Generated by Deployment Agent on Tue Oct 28 14:31:55 CDT 2025
# Phase 7: Advanced Deployment Automation

name: MomentumFinance CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment target'
        required: true
        default: 'testflight'
        type: choice
        options:
        - testflight
        - appstore

env:
  PROJECT_NAME: MomentumFinance
  SCHEME: MomentumFinance
  WORKSPACE: MomentumFinance.xcworkspace

jobs:

  build-and-test:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install dependencies
      run: |
        bundle install
        bundle exec pod install

    - name: Run tests
      run: |
        xcodebuild test \
          -workspace "${WORKSPACE}" \
          -scheme "${SCHEME}" \
          -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' \
          -resultBundlePath TestResults \
          -enableCodeCoverage YES

    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: TestResults.xcresult

  deploy-testflight:
    needs: build-and-test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build and archive
      run: |
        xcodebuild archive \
          -workspace "${WORKSPACE}" \
          -scheme "${SCHEME}" \
          -configuration Release \
          -archivePath build/${PROJECT_NAME}.xcarchive \
          -allowProvisioningUpdates

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath build/${PROJECT_NAME}.xcarchive \
          -exportOptionsPlist exportOptions.plist \
          -exportPath build/

    - name: Upload to TestFlight
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file build/${PROJECT_NAME}.ipa \
          --username "${{ secrets.APPLE_ID }}" \
          --password "${{ secrets.APPLE_ID_PASSWORD }}"

# Generated by Deployment Automation Agent - Phase 7
