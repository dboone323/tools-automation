#!/bin/bash
# pre-commit hook: scan for secrets and security issues before committing
# Install with: git config core.hooksPath .githooks
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "[pre-commit] Running security checks..."

# Function to check for secrets in staged files
check_secrets() {
    local secret_found=0

    # Get list of staged files
    local staged_files
    staged_files=$(git diff --cached --name-only --diff-filter=ACM)

    if [[ -z "$staged_files" ]]; then
        echo "[pre-commit] No files staged for commit"
        return 0
    fi

    echo "[pre-commit] Scanning staged files for secrets..."

    # More specific patterns to avoid false positives - look for actual secret values
    local patterns=(
        # Password patterns - look for actual assignments
        "password\s*=\s*['\"][^'\"]{8,}['\"]"
        "passwd\s*=\s*['\"][^'\"]{8,}['\"]"
        "pwd\s*=\s*['\"][^'\"]{8,}['\"]"
        # Secret patterns - look for actual assignments
        "\bsecret\s*=\s*['\"][^'\"]{16,}['\"]"
        "SECRET\s*=\s*['\"][^'\"]{16,}['\"]"
        # API key patterns - look for actual assignments
        "\bapi[_-]?key\s*=\s*['\"][^'\"]{20,}['\"]"
        "apikey\s*=\s*['\"][^'\"]{20,}['\"]"
        # Token patterns - look for actual assignments
        "\btoken\s*=\s*['\"][^'\"]{20,}['\"]"
        "TOKEN\s*=\s*['\"][^'\"]{20,}['\"]"
        # Private key patterns
        "PRIVATE[_-]?KEY\s*=\s*['\"][a-zA-Z0-9+/=]{20,}['\"]"
    )

    for file in $staged_files; do
        if [[ -f "$file" ]]; then
            for pattern in "${patterns[@]}"; do
                if grep -q -E "$pattern" "$file" 2>/dev/null; then
                    echo "[pre-commit] ‚ùå POTENTIAL SECRET FOUND in $file"
                    echo "[pre-commit]   Pattern: $pattern"
                    grep -n -E "$pattern" "$file" | head -3
                    secret_found=1
                fi
            done
        fi
    done

    if [[ $secret_found -eq 1 ]]; then
        echo ""
        echo "[pre-commit] üö® SECURITY VIOLATION: Potential secrets detected!"
        echo "[pre-commit] Please remove secrets or use environment variables."
        echo "[pre-commit] Use 'git commit --no-verify' to bypass (NOT RECOMMENDED)"
        return 1
    fi

    echo "[pre-commit] ‚úÖ No secrets detected in staged files"
    return 0
}

# Function to check for debug code in production files
check_debug_code() {
    local debug_found=0

    # Get list of staged files
    local staged_files
    staged_files=$(git diff --cached --name-only --diff-filter=ACM)

    echo "[pre-commit] Checking for debug code in production files..."

    for file in $staged_files; do
        if [[ -f "$file" && "$file" != *test* && "$file" != *example* && "$file" != *mock* ]]; then
            # Check for debug statements (excluding legitimate logging)
            if grep -q "print(" "$file" 2>/dev/null && ! grep -q "logging\." "$file" 2>/dev/null; then
                echo "[pre-commit] ‚ö†Ô∏è  DEBUG CODE FOUND in $file (print statements)"
                debug_found=1
            fi

            if grep -q "pdb\.set_trace()" "$file" 2>/dev/null; then
                echo "[pre-commit] ‚ö†Ô∏è  DEBUG CODE FOUND in $file (pdb breakpoint)"
                debug_found=1
            fi

            if grep -q "import pdb" "$file" 2>/dev/null; then
                echo "[pre-commit] ‚ö†Ô∏è  DEBUG CODE FOUND in $file (pdb import)"
                debug_found=1
            fi
        fi
    done

    if [[ $debug_found -eq 1 ]]; then
        echo ""
        echo "[pre-commit] ‚ö†Ô∏è  WARNING: Debug code detected in production files"
        echo "[pre-commit] Consider removing debug statements before committing"
        echo "[pre-commit] Use 'git commit --no-verify' to bypass this warning"
        # Don't fail the commit for debug code, just warn
    else
        echo "[pre-commit] ‚úÖ No debug code issues found"
    fi
}

# Run security checks
check_secrets || exit 1
check_debug_code

echo "[pre-commit] ‚úÖ All security checks passed"
exit 0
