<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #4a5568;
            font-size: 1.2em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 500;
            color: #4a5568;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .metric-value.success { color: #48bb78; }
        .metric-value.warning { color: #ed8936; }
        .metric-value.error { color: #f56565; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.running { background: #48bb78; }
        .status-indicator.idle { background: #ed8936; }
        .status-indicator.error { background: #f56565; }

        .agent-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-name {
            font-weight: 500;
        }

        .agent-status {
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .agent-status.running {
            background: #c6f6d5;
            color: #22543d;
        }

        .agent-status.idle {
            background: #fed7cc;
            color: #7c2d12;
        }

        .agent-status.error {
            background: #fecaca;
            color: #991b1b;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .analytics-section {
            margin-top: 30px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .analytics-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1001;
            font-size: 12px;
        }

        .test-results {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .test-pass { color: #48bb78; }
        .test-fail { color: #f56565; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Agent Performance Dashboard</h1>
            <p>Real-time monitoring and analytics powered by Umami</p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">API Server: <span id="server-status">Checking...</span></p>
        </div>

        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Dashboard</button>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä System Performance</h3>
                <div id="system-metrics">
                    <div class="loading">Loading system metrics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Agent Status</h3>
                <div id="agent-status">
                    <div class="loading">Loading agent status...</div>
                </div>
                <div class="agent-list" id="agent-list">
                    <!-- Agent list will be populated here -->
                </div>
            </div>

            <div class="card">
                <h3>üõ†Ô∏è Tools Status</h3>
                <div id="tools-status">
                    <div class="loading">Loading tools status...</div>
                </div>
            </div>

            <div class="card">
                <h3>üèóÔ∏è Infrastructure</h3>
                <div id="infrastructure-status">
                    <div class="loading">Loading infrastructure status...</div>
                </div>
            </div>

            <div class="card">
                <h3>üéØ Task Analytics</h3>
                <div id="task-analytics">
                    <div class="loading">Loading task analytics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="taskChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üõ°Ô∏è Security Status</h3>
                <div id="security-status">
                    <div class="loading">Loading security status...</div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Performance Metrics</h3>
                <div id="performance-metrics">
                    <div class="loading">Loading performance metrics...</div>
                </div>
            </div>

            <div class="card">
                <h3>üß† AI/ML Performance</h3>
                <div id="ml-analytics">
                    <div class="loading">Loading ML analytics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="mlChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-section">
            <h2 style="text-align: center; color: white; margin-bottom: 20px;">üìà Umami Analytics Overview</h2>
            <div class="analytics-grid" id="umami-analytics">
                <div class="analytics-card">
                    <div class="analytics-value" id="total-events">--</div>
                    <div class="analytics-label">Total Events</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="unique-visitors">--</div>
                    <div class="analytics-label">Unique Visitors</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="page-views">--</div>
                    <div class="analytics-label">Page Views</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="avg-session">--</div>
                    <div class="analytics-label">Avg Session (min)</div>
                </div>
            </div>
        </div>
    </div>

    <button class="debug-toggle" onclick="toggleDebugPanel()">üêõ Debug</button>

    <div class="debug-panel" id="debug-panel">
        <h4>Debug Console</h4>
        <div id="debug-logs"></div>
        <button onclick="runTests()" style="margin-top: 10px; padding: 5px 10px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">Run Tests</button>
        <div id="test-results" class="test-results"></div>
    </div>

    <script>
        let performanceChart, taskChart, mlChart;
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            checkServerStatus(); // Check server status immediately
            refreshData();
            startAutoRefresh();
        });

        function initializeCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Task Chart
            const taskCtx = document.getElementById('taskChart').getContext('2d');
            taskChart = new Chart(taskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Failed', 'Running', 'Queued'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936', '#a0aec0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ML Performance Chart
            const mlCtx = document.getElementById('mlChart').getContext('2d');
            mlChart = new Chart(mlCtx, {
                type: 'bar',
                data: {
                    labels: ['Execution Time', 'Failure Rate', 'Accuracy'],
                    datasets: [{
                        label: 'ML Predictions',
                        data: [0, 0, 0],
                        backgroundColor: ['#667eea', '#764ba2', '#f56565'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/metrics/system');
                const isRunning = response.ok;
                document.getElementById('server-status').textContent = isRunning ? '‚úÖ Running (localhost:8085)' : '‚ùå Not Running';
                document.getElementById('server-status').style.color = isRunning ? '#48bb78' : '#f56565';
                return isRunning;
            } catch (error) {
                document.getElementById('server-status').textContent = '‚ùå Not Running';
                document.getElementById('server-status').style.color = '#f56565';
                return false;
            }
        }

        async function refreshData() {
            startPerfMark('refreshData');
            try {
                logDebug('Refreshing dashboard data...', 'info');

                // Check if server is running first
                const serverRunning = await checkServerStatus();
                if (!serverRunning) {
                    showServerError();
                    return;
                }

                // Fetch system metrics
                await loadSystemMetrics();

                // Fetch agent status
                await loadAgentStatus();

                // Fetch tools status
                await loadToolsStatus();

                // Fetch infrastructure status
                await loadInfrastructureStatus();

                // Fetch task analytics
                await loadTaskAnalytics();

                // Fetch security status
                await loadSecurityStatus();

                // Fetch performance metrics
                await loadPerformanceMetrics();

                // Fetch ML analytics
                await loadMLAnalytics();

                // Fetch Umami analytics
                await loadUmamiAnalytics();

                logDebug('Dashboard data refresh completed successfully', 'success');
                endPerfMark('refreshData');

            } catch (error) {
                logDebug(`Error refreshing data: ${error.message}`, 'error');
                endPerfMark('refreshData');
                showServerError();
            }
        }

        function showServerError() {
            const errorMessage = '<div class="loading">‚ùå API server not running. Please start the dashboard API server first.</div>';
            document.getElementById('system-metrics').innerHTML = errorMessage;
            document.getElementById('agent-status').innerHTML = errorMessage;
            document.getElementById('tools-status').innerHTML = errorMessage;
            document.getElementById('infrastructure-status').innerHTML = errorMessage;
            document.getElementById('task-analytics').innerHTML = errorMessage;
            document.getElementById('security-status').innerHTML = errorMessage;
            document.getElementById('performance-metrics').innerHTML = errorMessage;
            document.getElementById('ml-analytics').innerHTML = errorMessage;
        }

        async function loadSystemMetrics() {
            startPerfMark('loadSystemMetrics');
            try {
                logDebug('Loading system metrics...', 'info');
                const response = await fetch('http://localhost:8085/api/system/status');
                const data = await response.json();

                logDebug(`System metrics loaded: CPU ${data.cpu_usage}%, Memory ${data.memory_usage}%`, 'info');

                const metricsDiv = document.getElementById('system-metrics');
                metricsDiv.innerHTML = '';

                // Display current metrics
                const metrics = [
                    { label: 'CPU Usage', value: `${data.cpu_usage || 0}%`, class: getMetricClass(data.cpu_usage, 80) },
                    { label: 'Memory Usage', value: `${data.memory_usage || 0}%`, class: getMetricClass(data.memory_usage, 80) },
                    { label: 'Network Usage', value: `${data.network_usage || 0}%`, class: getMetricClass(data.network_usage, 70) },
                    { label: 'Active Agents', value: data.agent_count || 0, class: 'success' },
                    { label: 'Running Servers', value: Object.keys(data.servers || {}).length, class: 'success' },
                    { label: 'Healthy Services', value: Object.values(data.services || {}).filter(s => s.status === 'healthy').length, class: 'success' }
                ];

                metrics.forEach(metric => {
                    metricsDiv.innerHTML += `
                        <div class="metric">
                            <span class="metric-label">${metric.label}</span>
                            <span class="metric-value ${metric.class}">${metric.value}</span>
                        </div>
                    `;
                });

                // Update performance chart
                if (data.history && data.history.length > 0) {
                    const labels = data.history.map(h => new Date(h.timestamp * 1000).toLocaleTimeString());
                    const cpuData = data.history.map(h => parseFloat(h.cpu_usage));
                    const memData = data.history.map(h => parseFloat(h.memory_usage));

                    performanceChart.data.labels = labels;
                    performanceChart.data.datasets[0].data = cpuData;
                    performanceChart.data.datasets[1].data = memData;
                    performanceChart.update();
                    logDebug(`Performance chart updated with ${data.history.length} data points`, 'info');
                }

                endPerfMark('loadSystemMetrics');

            } catch (error) {
                logDebug(`Error loading system metrics: ${error.message}`, 'error');
                endPerfMark('loadSystemMetrics');
                document.getElementById('system-metrics').innerHTML = '<div class="loading">Error loading system metrics - API server may not be running</div>';
                console.error('Error loading system metrics:', error);
            }
        }

        async function loadAgentStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/agents/status');
                const data = await response.json();

                const statusDiv = document.getElementById('agent-status');
                const agentListDiv = document.getElementById('agent-list');

                // Summary metrics
                const totalAgents = data.agents ? Object.keys(data.agents).length : 0;
                const runningAgents = data.agents ? Object.values(data.agents).filter(a => a.status === 'running').length : 0;
                const idleAgents = data.agents ? Object.values(data.agents).filter(a => a.status === 'idle' || a.status === 'available').length : 0;

                statusDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Agents</span>
                        <span class="metric-value success">${totalAgents}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Running</span>
                        <span class="metric-value success">${runningAgents}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Idle</span>
                        <span class="metric-value warning">${idleAgents}</span>
                    </div>
                `;

                // Agent list - show top 8 agents
                agentListDiv.innerHTML = '';
                if (data.agents) {
                    Object.entries(data.agents).slice(0, 8).forEach(([name, agent]) => {
                        const statusClass = agent.status === 'running' ? 'running' :
                                          agent.status === 'idle' ? 'idle' : 'error';
                        agentListDiv.innerHTML += `
                            <div class="agent-item">
                                <span class="agent-name">${name.replace(/_/g, ' ')}</span>
                                <span class="agent-status ${statusClass}">${agent.status}</span>
                            </div>
                        `;
                    });
                }

            } catch (error) {
                document.getElementById('agent-status').innerHTML = '<div class="loading">Error loading agent status - API server may not be running</div>';
                console.error('Error loading agent status:', error);
            }
        }

        async function loadToolsStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/tools/status');
                const data = await response.json();

                const toolsDiv = document.getElementById('tools-status');
                toolsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Tools</span>
                        <span class="metric-value success">${data.total_tools || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Tools</span>
                        <span class="metric-value success">${data.active_tools || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Idle Tools</span>
                        <span class="metric-value warning">${data.idle_tools || 0}</span>
                    </div>
                `;

            } catch (error) {
                document.getElementById('tools-status').innerHTML = '<div class="loading">Error loading tools status</div>';
                console.error('Error loading tools status:', error);
            }
        }

        async function loadInfrastructureStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/infrastructure/status');
                const data = await response.json();

                const infraDiv = document.getElementById('infrastructure-status');
                infraDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Compute Instances</span>
                        <span class="metric-value success">${data.infrastructure?.compute?.total_instances || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Storage Used</span>
                        <span class="metric-value ${getMetricClass(65, 90)}">6.2TB / 8.89TB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Health Score</span>
                        <span class="metric-value ${getMetricClass(data.health_score || 0, 95)}">${data.health_score || 0}%</span>
                    </div>
                `;

            } catch (error) {
                document.getElementById('infrastructure-status').innerHTML = '<div class="loading">Error loading infrastructure status</div>';
                console.error('Error loading infrastructure status:', error);
            }
        }

        async function loadSecurityStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/security/status');
                const data = await response.json();

                const securityDiv = document.getElementById('security-status');
                securityDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Security Score</span>
                        <span class="metric-value ${getMetricClass(data.overall_security_score || 0, 90)}">${data.overall_security_score || 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Sessions</span>
                        <span class="metric-value success">${data.security?.access_control?.active_sessions || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Threats Blocked</span>
                        <span class="metric-value success">${data.security?.threat_detection?.threats_blocked || 0}</span>
                    </div>
                `;

            } catch (error) {
                document.getElementById('security-status').innerHTML = '<div class="loading">Error loading security status</div>';
                console.error('Error loading security status:', error);
            }
        }

        async function loadPerformanceMetrics() {
            try {
                const response = await fetch('http://localhost:8085/api/performance/metrics');
                const data = await response.json();

                const perfDiv = document.getElementById('performance-metrics');
                perfDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Requests/sec</span>
                        <span class="metric-value success">${data.performance?.throughput?.requests_per_second || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Response</span>
                        <span class="metric-value ${getMetricClass(data.performance?.response_times?.api_gateway?.p95 || 0, 500)}">${data.performance?.response_times?.api_gateway?.p50 || 0}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Error Rate</span>
                        <span class="metric-value ${getMetricClass((data.performance?.error_rates?.http_5xx_rate || 0) * 100, 1)}">${(data.performance?.error_rates?.http_5xx_rate || 0) * 100}%</span>
                    </div>
                `;

            } catch (error) {
                document.getElementById('performance-metrics').innerHTML = '<div class="loading">Error loading performance metrics</div>';
                console.error('Error loading performance metrics:', error);
            }
        }

        async function loadTaskAnalytics() {
            try {
                const response = await fetch('http://localhost:8085/api/tasks/analytics');
                const data = await response.json();

                const analyticsDiv = document.getElementById('task-analytics');
                analyticsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Tasks</span>
                        <span class="metric-value success">${data.total_tasks || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Success Rate</span>
                        <span class="metric-value ${getMetricClass((data.success_rate || 0) * 100, 95)}">${((data.success_rate || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Throughput/hr</span>
                        <span class="metric-value success">${data.performance?.throughput_per_hour || 0}</span>
                    </div>
                `;

                // Update task chart with more comprehensive data
                taskChart.data.datasets[0].data = [
                    data.completed || 0,
                    data.failed || 0,
                    data.running || 0,
                    data.queued || 0
                ];
                taskChart.data.labels = ['Completed', 'Failed', 'Running', 'Queued'];
                taskChart.update();

            } catch (error) {
                document.getElementById('task-analytics').innerHTML = '<div class="loading">Error loading task analytics - API server may not be running</div>';
                console.error('Error loading task analytics:', error);
            }
        }

        async function loadMLAnalytics() {
            try {
                const response = await fetch('http://localhost:8085/api/ml/analytics');
                const data = await response.json();

                const analyticsDiv = document.getElementById('ml-analytics');
                analyticsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Avg Accuracy</span>
                        <span class="metric-value ${getMetricClass((data.overall_metrics?.avg_accuracy || 0) * 100, 80)}">${((data.overall_metrics?.avg_accuracy || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Predictions</span>
                        <span class="metric-value success">${data.overall_metrics?.total_predictions || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Models Deployed</span>
                        <span class="metric-value success">${data.overall_metrics?.models_deployed || 0}</span>
                    </div>
                `;

                // Update ML chart with new data
                mlChart.data.datasets[0].data = [
                    data.performance_metrics?.avg_inference_time || 0,
                    (data.performance_metrics?.cpu_usage || 0),
                    (data.overall_metrics?.avg_accuracy || 0) * 100
                ];
                mlChart.update();

            } catch (error) {
                document.getElementById('ml-analytics').innerHTML = '<div class="loading">Error loading ML analytics - API server may not be running</div>';
                console.error('Error loading ML analytics:', error);
            }
        }

        async function loadUmamiAnalytics() {
            try {
                const response = await fetch('http://localhost:8085/api/umami/stats');
                const data = await response.json();

                document.getElementById('total-events').textContent = data.total_events || '--';
                document.getElementById('unique-visitors').textContent = data.unique_visitors || '--';
                document.getElementById('page-views').textContent = data.page_views || '--';
                document.getElementById('avg-session').textContent = data.avg_session_duration || '--';

            } catch (error) {
                console.error('Error loading Umami analytics:', error);
                // Don't show error for Umami as it might not be available
            }
        }

        function getMetricClass(value, threshold) {
            if (value >= threshold) return 'error';
            if (value >= threshold * 0.8) return 'warning';
            return 'success';
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Debug and Test Functions
        let debugLogs = [];
        let debugEnabled = false;

        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            debugEnabled = !debugEnabled;
        }

        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLogs.push(logEntry);
            console.log(logEntry);

            if (debugEnabled) {
                const debugDiv = document.getElementById('debug-logs');
                debugDiv.innerHTML += `<div>${logEntry}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function runTests() {
            logDebug('Starting dashboard tests...', 'test');
            const results = document.getElementById('test-results');
            results.innerHTML = '<div>Running tests...</div>';

            const tests = [
                testApiConnectivity,
                testChartInitialization,
                testDataLoading,
                testErrorHandling,
                testPerformanceMetrics
            ];

            let passed = 0;
            let failed = 0;
            const testResults = [];

            tests.forEach(async (test, index) => {
                try {
                    const result = await test();
                    if (result) {
                        passed++;
                        testResults.push(`<div class="test-pass">‚úì Test ${index + 1}: ${test.name} - PASSED</div>`);
                        logDebug(`Test ${test.name} passed`, 'test');
                    } else {
                        failed++;
                        testResults.push(`<div class="test-fail">‚úó Test ${index + 1}: ${test.name} - FAILED</div>`);
                        logDebug(`Test ${test.name} failed`, 'error');
                    }
                } catch (error) {
                    failed++;
                    testResults.push(`<div class="test-fail">‚úó Test ${index + 1}: ${test.name} - ERROR: ${error.message}</div>`);
                    logDebug(`Test ${test.name} error: ${error.message}`, 'error');
                }
            });

            setTimeout(() => {
                results.innerHTML = `
                    <div><strong>Test Results: ${passed} passed, ${failed} failed</strong></div>
                    ${testResults.join('')}
                `;
            }, 1000);
        }

        async function testApiConnectivity() {
            try {
                const response = await fetch('http://localhost:8085/api/system/status');
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function testChartInitialization() {
            return performanceChart && taskChart && mlChart;
        }

        async function testDataLoading() {
            try {
                const response = await fetch('http://localhost:8085/api/system/status');
                const data = await response.json();
                return data && typeof data === 'object';
            } catch (error) {
                return false;
            }
        }

        function testErrorHandling() {
            // Test error handling by temporarily breaking an API call
            const originalFetch = window.fetch;
            window.fetch = () => Promise.reject(new Error('Test error'));
            try {
                // This should trigger error handling
                refreshData();
                return true; // If no exception thrown, error handling works
            } catch (error) {
                return false;
            } finally {
                window.fetch = originalFetch;
            }
        }

        function testPerformanceMetrics() {
            const startTime = performance.now();
            // Simulate some operations
            for (let i = 0; i < 1000; i++) {
                Math.sqrt(i);
            }
            const endTime = performance.now();
            const duration = endTime - startTime;
            logDebug(`Performance test: ${duration.toFixed(2)}ms`, 'perf');
            return duration < 50; // Should complete in less than 50ms
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            logDebug(`JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            logDebug(`Unhandled Promise Rejection: ${e.reason}`, 'error');
        });

        // Performance monitoring
        let performanceMarks = {};
        function startPerfMark(name) {
            performanceMarks[name] = performance.now();
        }

        function endPerfMark(name) {
            if (performanceMarks[name]) {
                const duration = performance.now() - performanceMarks[name];
                logDebug(`Performance: ${name} took ${duration.toFixed(2)}ms`, 'perf');
                delete performanceMarks[name];
            }
        }
    </script>
</body>
</html>