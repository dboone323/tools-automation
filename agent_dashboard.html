<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #4a5568;
            font-size: 1.2em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 500;
            color: #4a5568;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .metric-value.success { color: #48bb78; }
        .metric-value.warning { color: #ed8936; }
        .metric-value.error { color: #f56565; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.running { background: #48bb78; }
        .status-indicator.idle { background: #ed8936; }
        .status-indicator.error { background: #f56565; }

        .agent-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-name {
            font-weight: 500;
        }

        .agent-status {
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .agent-status.running {
            background: #c6f6d5;
            color: #22543d;
        }

        .agent-status.idle {
            background: #fed7cc;
            color: #7c2d12;
        }

        .agent-status.error {
            background: #fecaca;
            color: #991b1b;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .analytics-section {
            margin-top: 30px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .analytics-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Agent Performance Dashboard</h1>
            <p>Real-time monitoring and analytics powered by Umami</p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">API Server: <span id="server-status">Checking...</span></p>
        </div>

        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Dashboard</button>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä System Performance</h3>
                <div id="system-metrics">
                    <div class="loading">Loading system metrics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Agent Status</h3>
                <div id="agent-status">
                    <div class="loading">Loading agent status...</div>
                </div>
                <div class="agent-list" id="agent-list">
                    <!-- Agent list will be populated here -->
                </div>
            </div>

            <div class="card">
                <h3>üéØ Task Analytics</h3>
                <div id="task-analytics">
                    <div class="loading">Loading task analytics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="taskChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üß† AI/ML Performance</h3>
                <div id="ml-analytics">
                    <div class="loading">Loading ML analytics...</div>
                </div>
                <div class="chart-container">
                    <canvas id="mlChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-section">
            <h2 style="text-align: center; color: white; margin-bottom: 20px;">üìà Umami Analytics Overview</h2>
            <div class="analytics-grid" id="umami-analytics">
                <div class="analytics-card">
                    <div class="analytics-value" id="total-events">--</div>
                    <div class="analytics-label">Total Events</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="unique-visitors">--</div>
                    <div class="analytics-label">Unique Visitors</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="page-views">--</div>
                    <div class="analytics-label">Page Views</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="avg-session">--</div>
                    <div class="analytics-label">Avg Session (min)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let performanceChart, taskChart, mlChart;
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            checkServerStatus(); // Check server status immediately
            refreshData();
            startAutoRefresh();
        });

        function initializeCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Task Chart
            const taskCtx = document.getElementById('taskChart').getContext('2d');
            taskChart = new Chart(taskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Failed', 'Running'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ML Performance Chart
            const mlCtx = document.getElementById('mlChart').getContext('2d');
            mlChart = new Chart(mlCtx, {
                type: 'bar',
                data: {
                    labels: ['Execution Time', 'Failure Rate', 'Accuracy'],
                    datasets: [{
                        label: 'ML Predictions',
                        data: [0, 0, 0],
                        backgroundColor: ['#667eea', '#764ba2', '#f56565'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:5001/health');
                const isRunning = response.ok;
                document.getElementById('server-status').textContent = isRunning ? '‚úÖ Running (localhost:5001)' : '‚ùå Not Running';
                document.getElementById('server-status').style.color = isRunning ? '#48bb78' : '#f56565';
                return isRunning;
            } catch (error) {
                document.getElementById('server-status').textContent = '‚ùå Not Running';
                document.getElementById('server-status').style.color = '#f56565';
                return false;
            }
        }

        async function refreshData() {
            try {
                // Check if server is running first
                const serverRunning = await checkServerStatus();
                if (!serverRunning) {
                    showServerError();
                    return;
                }

                // Fetch system metrics
                await loadSystemMetrics();

                // Fetch agent status
                await loadAgentStatus();

                // Fetch task analytics
                await loadTaskAnalytics();

                // Fetch ML analytics
                await loadMLAnalytics();

                // Fetch Umami analytics
                await loadUmamiAnalytics();

            } catch (error) {
                console.error('Error refreshing data:', error);
                showServerError();
            }
        }

        function showServerError() {
            const errorMessage = '<div class="loading">‚ùå API server not running. Please start the dashboard API server first.</div>';
            document.getElementById('system-metrics').innerHTML = errorMessage;
            document.getElementById('agent-status').innerHTML = errorMessage;
            document.getElementById('task-analytics').innerHTML = errorMessage;
            document.getElementById('ml-analytics').innerHTML = errorMessage;
        }

        async function loadSystemMetrics() {
            try {
                const response = await fetch('http://localhost:5001/api/metrics/system');
                const data = await response.json();

                const metricsDiv = document.getElementById('system-metrics');
                metricsDiv.innerHTML = '';

                // Display current metrics
                const metrics = [
                    { label: 'CPU Usage', value: `${data.cpu_usage || 0}%`, class: getMetricClass(data.cpu_usage, 80) },
                    { label: 'Memory Usage', value: `${data.memory_usage || 0}%`, class: getMetricClass(data.memory_usage, 80) },
                    { label: 'Disk Usage', value: `${data.disk_usage || 0}%`, class: getMetricClass(data.disk_usage, 90) },
                    { label: 'Active Agents', value: data.agent_count || 0, class: 'success' }
                ];

                metrics.forEach(metric => {
                    metricsDiv.innerHTML += `
                        <div class="metric">
                            <span class="metric-label">${metric.label}</span>
                            <span class="metric-value ${metric.class}">${metric.value}</span>
                        </div>
                    `;
                });

                // Update performance chart
                if (data.history && data.history.length > 0) {
                    const labels = data.history.map(h => new Date(h.timestamp * 1000).toLocaleTimeString());
                    const cpuData = data.history.map(h => parseFloat(h.cpu_usage));
                    const memData = data.history.map(h => parseFloat(h.memory_usage));

                    performanceChart.data.labels = labels;
                    performanceChart.data.datasets[0].data = cpuData;
                    performanceChart.data.datasets[1].data = memData;
                    performanceChart.update();
                }

            } catch (error) {
                document.getElementById('system-metrics').innerHTML = '<div class="loading">Error loading system metrics - API server may not be running</div>';
                console.error('Error loading system metrics:', error);
            }
        }

        async function loadAgentStatus() {
            try {
                const response = await fetch('http://localhost:5001/api/agents/status');
                const data = await response.json();

                const statusDiv = document.getElementById('agent-status');
                const agentListDiv = document.getElementById('agent-list');

                // Summary metrics
                const totalAgents = data.agents ? Object.keys(data.agents).length : 0;
                const runningAgents = data.agents ? Object.values(data.agents).filter(a => a.status === 'running').length : 0;
                const idleAgents = data.agents ? Object.values(data.agents).filter(a => a.status === 'idle' || a.status === 'available').length : 0;

                statusDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Agents</span>
                        <span class="metric-value success">${totalAgents}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Running</span>
                        <span class="metric-value success">${runningAgents}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Idle</span>
                        <span class="metric-value warning">${idleAgents}</span>
                    </div>
                `;

                // Agent list
                agentListDiv.innerHTML = '';
                if (data.agents) {
                    Object.entries(data.agents).forEach(([name, agent]) => {
                        const statusClass = agent.status === 'running' ? 'running' :
                                          agent.status === 'idle' ? 'idle' : 'error';
                        agentListDiv.innerHTML += `
                            <div class="agent-item">
                                <span class="agent-name">${name}</span>
                                <span class="agent-status ${statusClass}">${agent.status}</span>
                            </div>
                        `;
                    });
                }

            } catch (error) {
                document.getElementById('agent-status').innerHTML = '<div class="loading">Error loading agent status - API server may not be running</div>';
                console.error('Error loading agent status:', error);
            }
        }

        async function loadTaskAnalytics() {
            try {
                const response = await fetch('http://localhost:5001/api/tasks/analytics');
                const data = await response.json();

                const analyticsDiv = document.getElementById('task-analytics');
                analyticsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Tasks</span>
                        <span class="metric-value success">${data.total_tasks || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Success Rate</span>
                        <span class="metric-value ${getMetricClass((data.success_rate || 0) * 100, 95)}">${((data.success_rate || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Duration</span>
                        <span class="metric-value">${(data.avg_duration || 0).toFixed(1)}s</span>
                    </div>
                `;

                // Update task chart
                taskChart.data.datasets[0].data = [
                    data.completed || 0,
                    data.failed || 0,
                    data.running || 0
                ];
                taskChart.update();

            } catch (error) {
                document.getElementById('task-analytics').innerHTML = '<div class="loading">Error loading task analytics - API server may not be running</div>';
                console.error('Error loading task analytics:', error);
            }
        }

        async function loadMLAnalytics() {
            try {
                const response = await fetch('http://localhost:5001/api/ml/analytics');
                const data = await response.json();

                const analyticsDiv = document.getElementById('ml-analytics');
                analyticsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Model Accuracy</span>
                        <span class="metric-value ${getMetricClass((data.accuracy || 0) * 100, 80)}">${((data.accuracy || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Predictions Made</span>
                        <span class="metric-value success">${data.predictions_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last Training</span>
                        <span class="metric-value">${data.last_training || 'Never'}</span>
                    </div>
                `;

                // Update ML chart
                mlChart.data.datasets[0].data = [
                    data.avg_predicted_time || 0,
                    (data.avg_failure_prob || 0) * 100,
                    (data.accuracy || 0) * 100
                ];
                mlChart.update();

            } catch (error) {
                document.getElementById('ml-analytics').innerHTML = '<div class="loading">Error loading ML analytics - API server may not be running</div>';
                console.error('Error loading ML analytics:', error);
            }
        }

        async function loadUmamiAnalytics() {
            try {
                const response = await fetch('http://localhost:5001/api/umami/stats');
                const data = await response.json();

                document.getElementById('total-events').textContent = data.total_events || '--';
                document.getElementById('unique-visitors').textContent = data.unique_visitors || '--';
                document.getElementById('page-views').textContent = data.page_views || '--';
                document.getElementById('avg-session').textContent = data.avg_session_duration || '--';

            } catch (error) {
                console.error('Error loading Umami analytics:', error);
                // Don't show error for Umami as it might not be available
            }
        }

        function getMetricClass(value, threshold) {
            if (value >= threshold) return 'error';
            if (value >= threshold * 0.8) return 'warning';
            return 'success';
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>