<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Todo Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .metric-label {
            color: #666;
        }

        .status-critical { color: #e74c3c; }
        .status-high { color: #f39c12; }
        .status-medium { color: #f1c40f; }
        .status-low { color: #27ae60; }

        .todo-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .todo-item {
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #fafafa;
        }

        .todo-item.high { border-left: 4px solid #e74c3c; }
        .todo-item.medium { border-left: 4px solid #f39c12; }
        .todo-item.low { border-left: 4px solid #27ae60; }

        .todo-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .todo-meta {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1001;
            font-size: 12px;
        }

        .test-results {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .test-pass { color: #48bb78; }
        .test-fail { color: #f56565; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Unified Todo Management</h1>
        <p>AI-Powered Todo Management Across All Project Aspects</p>
        <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">API Server: <span id="server-status">Checking...</span></p>
    </div>

    <div class="container">
        <div class="actions">
            <button class="btn btn-primary" onclick="analyzeProject()">üîç Analyze Project</button>
            <button class="btn btn-secondary" onclick="processTodos()">‚öôÔ∏è Process Todos</button>
            <button class="btn btn-success" onclick="executeCritical()">üöÄ Execute Critical</button>
            <button class="btn btn-secondary" onclick="generateReport()">üìä Generate Report</button>
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div class="dashboard-grid">
            <!-- Overview Metrics -->
            <div class="card">
                <h3>üìä Overview</h3>
                <div id="overview-metrics">
                    <div class="loading">Loading metrics...</div>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="card">
                <h3>üìà Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="card">
                <h3>üè∑Ô∏è Category Distribution</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Priority Distribution -->
            <div class="card">
                <h3>‚ö° Priority Distribution</h3>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h3>üïê Recent Activity</h3>
                <div id="recent-activity">
                    <div class="loading">Loading activity...</div>
                </div>
            </div>

            <!-- Pending Todos -->
            <div class="card">
                <h3>‚è≥ Pending Todos</h3>
                <div id="pending-todos" class="todo-list">
                    <div class="loading">Loading todos...</div>
                </div>
            </div>

            <!-- Critical Todos -->
            <div class="card">
                <h3>üö® Critical Todos</h3>
                <div id="critical-todos" class="todo-list">
                    <div class="loading">Loading critical todos...</div>
                </div>
            </div>

            <!-- Agent Status -->
            <div class="card">
                <h3>ü§ñ Agent Status</h3>
                <div id="agent-status">
                    <div class="loading">Loading agent status...</div>
                </div>
            </div>
        </div>
    </div>

    <button class="debug-toggle" onclick="toggleDebugPanel()">üêõ Debug</button>

    <div class="debug-panel" id="debug-panel">
        <h4>Debug Console</h4>
        <div id="debug-logs"></div>
        <button onclick="runTests()" style="margin-top: 10px; padding: 5px 10px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">Run Tests</button>
        <div id="test-results" class="test-results"></div>
    </div>

    <script>
        let dashboardData = {};
        let statusChart, categoryChart, priorityChart;

        // Initialize charts
        function initCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#27ae60', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#27ae60', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:8085/api/metrics/system');
                const isRunning = response.ok;
                document.getElementById('server-status').textContent = isRunning ? '‚úÖ Running (localhost:8085)' : '‚ùå Not Running';
                document.getElementById('server-status').style.color = isRunning ? '#27ae60' : '#e74c3c';
                return isRunning;
            } catch (error) {
                document.getElementById('server-status').textContent = '‚ùå Not Running';
                document.getElementById('server-status').style.color = '#e74c3c';
                return false;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            startPerfMark('loadDashboardData');
            try {
                logDebug('Loading todo dashboard data...', 'info');
                const response = await fetch('/api/todo/dashboard');
                if (!response.ok) throw new Error('Failed to load dashboard data');

                dashboardData = await response.json();
                logDebug(`Dashboard data loaded: ${dashboardData.total_todos} todos`, 'info');
                updateDashboard();
                endPerfMark('loadDashboardData');
            } catch (error) {
                logDebug(`Error loading dashboard data: ${error.message}`, 'error');
                endPerfMark('loadDashboardData');
                showError('Failed to load dashboard data: ' + error.message);
            }
        }

        // Update dashboard display
        function updateDashboard() {
            updateOverview();
            updateCharts();
            updateRecentActivity();
            updatePendingTodos();
            updateCriticalTodos();
            updateAgentStatus();
        }

        function updateOverview() {
            const overview = document.getElementById('overview-metrics');
            overview.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total Todos</span>
                    <span class="metric-value">${dashboardData.total_todos || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pending</span>
                    <span class="metric-value status-medium">${dashboardData.by_status?.pending || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">In Progress</span>
                    <span class="metric-value status-high">${dashboardData.by_status?.in_progress || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Completed</span>
                    <span class="metric-value status-low">${dashboardData.by_status?.completed || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Overdue</span>
                    <span class="metric-value status-critical">${dashboardData.overdue || 0}</span>
                </div>
            `;
        }

        function updateCharts() {
            // Status chart
            const statusData = dashboardData.by_status || {};
            statusChart.data.labels = Object.keys(statusData);
            statusChart.data.datasets[0].data = Object.values(statusData);
            statusChart.update();

            // Category chart
            const categoryData = dashboardData.by_category || {};
            categoryChart.data.labels = Object.keys(categoryData);
            categoryChart.data.datasets[0].data = Object.values(categoryData);
            categoryChart.update();

            // Priority chart
            const priorityData = dashboardData.by_priority || {};
            priorityChart.data.labels = Object.keys(priorityData);
            priorityChart.data.datasets[0].data = Object.values(priorityData);
            priorityChart.update();
        }

        function updateRecentActivity() {
            const activity = document.getElementById('recent-activity');
            const activities = dashboardData.recent_activity || [];

            if (activities.length === 0) {
                activity.innerHTML = '<p>No recent activity</p>';
                return;
            }

            activity.innerHTML = activities.map(item => `
                <div class="todo-item">
                    <div class="todo-title">${item.title}</div>
                    <div class="todo-meta">
                        <span>Status: ${item.status}</span>
                        <span>${new Date(item.updated_at).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function updatePendingTodos() {
            // This would need to fetch pending todos separately
            const pending = document.getElementById('pending-todos');
            pending.innerHTML = '<p>Pending todos would be loaded here...</p>';
        }

        function updateCriticalTodos() {
            const critical = document.getElementById('critical-todos');
            critical.innerHTML = '<p>Critical todos would be loaded here...</p>';
        }

        function updateAgentStatus() {
            const agent = document.getElementById('agent-status');
            agent.innerHTML = '<p>Agent status would be loaded here...</p>';
        }

        // Action handlers
        async function analyzeProject() {
            try {
                const response = await fetch('/api/todo/analyze', { method: 'POST' });
                const result = await response.json();
                alert(`Analysis complete! Created ${result.todos_created} todos.`);
                loadDashboardData();
            } catch (error) {
                showError('Analysis failed: ' + error.message);
            }
        }

        async function processTodos() {
            try {
                const response = await fetch('/api/todo/process', { method: 'POST' });
                const result = await response.json();
                alert('Todo processing complete!');
                loadDashboardData();
            } catch (error) {
                showError('Processing failed: ' + error.message);
            }
        }

        async function executeCritical() {
            try {
                const response = await fetch('/api/todo/execute-critical', { method: 'POST' });
                const result = await response.json();
                alert('Critical todo execution complete!');
                loadDashboardData();
            } catch (error) {
                showError('Execution failed: ' + error.message);
            }
        }

        async function generateReport() {
            try {
                const response = await fetch('/api/todo/report', { method: 'POST' });
                const result = await response.json();
                alert('Report generated successfully!');
            } catch (error) {
                showError('Report generation failed: ' + error.message);
            }
        }

        async function refreshData() {
            startPerfMark('refreshData');
            try {
                logDebug('Refreshing todo dashboard data...', 'info');

                // Check if server is running first
                const serverRunning = await checkServerStatus();
                if (!serverRunning) {
                    showServerError();
                    return;
                }

                await loadDashboardData();
                logDebug('Todo dashboard data refresh completed successfully', 'success');
                endPerfMark('refreshData');

            } catch (error) {
                logDebug(`Error refreshing data: ${error.message}`, 'error');
                endPerfMark('refreshData');
                showServerError();
            }
        }

        function showServerError() {
            const errorMessage = '<div class="loading">‚ùå API server not running. Please start the dashboard API server first.</div>';
            document.getElementById('overview-metrics').innerHTML = errorMessage;
            document.getElementById('recent-activity').innerHTML = errorMessage;
            document.getElementById('pending-todos').innerHTML = errorMessage;
            document.getElementById('critical-todos').innerHTML = errorMessage;
            document.getElementById('agent-status').innerHTML = errorMessage;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            checkServerStatus(); // Check server status immediately
            loadDashboardData();

            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        // Debug and Test Functions
        let debugLogs = [];
        let debugEnabled = false;

        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            debugEnabled = !debugEnabled;
        }

        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLogs.push(logEntry);
            console.log(logEntry);

            if (debugEnabled) {
                const debugDiv = document.getElementById('debug-logs');
                debugDiv.innerHTML += `<div>${logEntry}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function runTests() {
            logDebug('Starting todo dashboard tests...', 'test');
            const results = document.getElementById('test-results');
            results.innerHTML = '<div>Running tests...</div>';

            const tests = [
                testApiConnectivity,
                testChartInitialization,
                testDataLoading,
                testErrorHandling,
                testPerformanceMetrics
            ];

            let passed = 0;
            let failed = 0;
            const testResults = [];

            tests.forEach(async (test, index) => {
                try {
                    const result = await test();
                    if (result) {
                        passed++;
                        testResults.push(`<div class="test-pass">‚úì Test ${index + 1}: ${test.name} - PASSED</div>`);
                        logDebug(`Test ${test.name} passed`, 'test');
                    } else {
                        failed++;
                        testResults.push(`<div class="test-fail">‚úó Test ${index + 1}: ${test.name} - FAILED</div>`);
                        logDebug(`Test ${test.name} failed`, 'error');
                    }
                } catch (error) {
                    failed++;
                    testResults.push(`<div class="test-fail">‚úó Test ${index + 1}: ${test.name} - ERROR: ${error.message}</div>`);
                    logDebug(`Test ${test.name} error: ${error.message}`, 'error');
                }
            });

            setTimeout(() => {
                results.innerHTML = `
                    <div><strong>Test Results: ${passed} passed, ${failed} failed</strong></div>
                    ${testResults.join('')}
                `;
            }, 1000);
        }

        async function testApiConnectivity() {
            try {
                const response = await fetch('/api/todo/dashboard');
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function testChartInitialization() {
            return statusChart && categoryChart && priorityChart;
        }

        async function testDataLoading() {
            try {
                const response = await fetch('/api/todo/dashboard');
                const data = await response.json();
                return data && typeof data === 'object';
            } catch (error) {
                return false;
            }
        }

        function testErrorHandling() {
            const originalFetch = window.fetch;
            window.fetch = () => Promise.reject(new Error('Test error'));
            try {
                loadDashboardData();
                return true;
            } catch (error) {
                return false;
            } finally {
                window.fetch = originalFetch;
            }
        }

        function testPerformanceMetrics() {
            const startTime = performance.now();
            for (let i = 0; i < 1000; i++) {
                Math.sqrt(i);
            }
            const endTime = performance.now();
            const duration = endTime - startTime;
            logDebug(`Performance test: ${duration.toFixed(2)}ms`, 'perf');
            return duration < 50;
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            logDebug(`JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            logDebug(`Unhandled Promise Rejection: ${e.reason}`, 'error');
        });

        // Performance monitoring
        let performanceMarks = {};
        function startPerfMark(name) {
            performanceMarks[name] = performance.now();
        }

        function endPerfMark(name) {
            if (performanceMarks[name]) {
                const duration = performance.now() - performanceMarks[name];
                logDebug(`Performance: ${name} took ${duration.toFixed(2)}ms`, 'perf');
                delete performanceMarks[name];
            }
        }
    </script>
</body>
</html>