name: ðŸ”’ Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Check for secrets using TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, python, shell

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        ignore_paths: node_modules

    - name: Security audit for Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety
        safety check --output text || true

    - name: Check for large files
      run: |
        find . -type f -size +50M -not -path './.git/*' | head -10 || echo "No large files found"

    - name: Validate repository structure
      run: |
        # Check for required security files
        [[ -f ".github/SECURITY.md" ]] || (echo "SECURITY.md missing" && exit 1)
        [[ -f ".github/dependabot.yml" ]] || (echo "dependabot.yml missing" && exit 1)

        # Check for sensitive files that shouldn't be committed
        if find . -name "*.key" -o -name "*.pem" -o -name "*secret*" -o -name ".env*" | grep -v node_modules | grep -v .git; then
          echo "Potential sensitive files found!"
          exit 1
        fi

        echo "âœ… Repository structure validation passed"