---
name: Submodule Fast Validation
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch: {}

jobs:
    validate:
        runs-on: macos-latest
        strategy:
            fail-fast: false
            matrix:
                submodule:
                    [
                        CodingReviewer,
                        PlannerApp,
                        HabitQuest,
                        MomentumFinance,
                        AvoidObstaclesGame,
                        shared-kit,
                    ]
        steps:
            - name: Checkout
              uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd
              with:
                  submodules: recursive

            - name: Setup Swift
              uses: swift-actions/setup-swift@v2
              with:
                  swift-version: "5.9"

            - name: Install SwiftLint (optional)
              run: |
                  brew install swiftlint || echo "SwiftLint optional"

            - name: Fast validate submodule
              run: |
                  bash scripts/submodule_fast_validate.sh \
                    "${{ matrix.submodule }}"

            - name: Upload validation artifact
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
              with:
                  name: validation-${{ matrix.submodule }}
                  path: metrics/validation/${{ matrix.submodule }}.json

    summary:
        runs-on: macos-latest
        needs: [validate]
        steps:
            - name: Checkout
              uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd
              with:
                  submodules: recursive

            - name: Download artifacts
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
              with:
                  path: metrics/validation
                  pattern: validation-*
                  merge-multiple: true

            - name: AI summary (optional)
              run: |
                  bash scripts/ollama_ci_summary.sh || true

            - name: Upload combined summary
              run: |
                  find metrics/validation -name '*.json' -type f | \
                    xargs jq -s '[.[]]' > metrics/validation/combined.json
              shell: bash

            - name: Store combined summary
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
              with:
                  name: validation-combined
                  path: metrics/validation/combined.json
