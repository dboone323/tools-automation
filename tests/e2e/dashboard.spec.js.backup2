import { test, expect } from '@playwright/test';

test.describe('Agent Dashboard E2E Tests', () => {
  test.beforeEach(async ({ page }) => {
    // Set up mock API responses for testing
    await page.route('http://localhost:5001/health', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({ status: 'healthy', uptime: 3600 })
      });
    });

    await page.route('http://localhost:5001/api/metrics/system', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          cpu_usage: 45.2,
          memory_usage: 62.8,
          disk_usage: 78.3,
          agent_count: 143,
          history: [
            { timestamp: Date.now() / 1000 - 300, cpu_usage: '42.1', memory_usage: '60.5' },
            { timestamp: Date.now() / 1000 - 240, cpu_usage: '44.8', memory_usage: '61.2' },
            { timestamp: Date.now() / 1000 - 180, cpu_usage: '45.2', memory_usage: '62.8' }
          ]
        })
      });
    });

    await page.route('http://localhost:5001/api/agents/status', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          agents: {
            'agent_health_check.sh': { status: 'running', last_seen: Date.now() / 1000 },
            'code_review_agent.sh': { status: 'idle', last_seen: Date.now() / 1000 - 60 },
            'test_runner.sh': { status: 'running', last_seen: Date.now() / 1000 - 30 },
            'performance_monitor.sh': { status: 'error', last_seen: Date.now() / 1000 - 120 }
          }
        })
      });
    });

    await page.route('http://localhost:5001/api/tasks/analytics', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          total_tasks: 1250,
          success_rate: 0.967,
          avg_duration: 2.3,
          completed: 1209,
          failed: 41,
          running: 12
        })
      });
    });

    await page.route('http://localhost:5001/api/ml/analytics', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          accuracy: 0.894,
          predictions_count: 567,
          last_training: '2024-01-15 14:30:00',
          avg_predicted_time: 1.2,
          avg_failure_prob: 0.023
        })
      });
    });

    await page.route('http://localhost:5001/api/umami/stats', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          total_events: 15420,
          unique_visitors: 892,
          page_views: 2341,
          avg_session_duration: 4.7
        })
      });
    });
  });

  test('loads main dashboard with all sections', async ({ page }) => {
    await page.goto('/');

    // Check main header
    await expect(page.locator('text=ðŸ¤– Agent Performance Dashboard')).toBeVisible();
    await expect(page.locator('text=Real-time monitoring and analytics powered by Umami')).toBeVisible();

    // Check all dashboard cards are present
    await expect(page.locator('text=ðŸ“Š System Performance')).toBeVisible();
    await expect(page.locator('text=âš™ï¸ Agent Status')).toBeVisible();
    await expect(page.locator('text=ðŸŽ¯ Task Analytics')).toBeVisible();
    await expect(page.locator('text=ðŸ§  AI/ML Performance')).toBeVisible();

    // Check analytics section
    await expect(page.locator('text=ðŸ“ˆ Umami Analytics Overview')).toBeVisible();
  });

  test('displays server status correctly', async ({ page }) => {
    await page.goto('/');

    // Wait for server status check to complete
    await page.waitForTimeout(1000);

    // Check server status indicator
    const serverStatus = page.locator('#server-status');
    await expect(serverStatus).toContainText('âœ… Running');
  });

  test('loads and displays system metrics', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Check system metrics are displayed
    await expect(page.locator('text=CPU Usage')).toBeVisible();
    await expect(page.locator('text=45.2%')).toBeVisible();
    await expect(page.locator('text=Memory Usage')).toBeVisible();
    await expect(page.locator('text=62.8%')).toBeVisible();
    await expect(page.locator('text=Disk Usage')).toBeVisible();
    await expect(page.locator('text=78.3%')).toBeVisible();
    await expect(page.locator('text=Active Agents')).toBeVisible();
    await expect(page.locator('text=143')).toBeVisible();
  });

  test('displays agent status and list', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Check agent summary metrics
    await expect(page.locator('text=Total Agents')).toBeVisible();
    await expect(page.locator('text=4')).toBeVisible(); // Mock data has 4 agents
    await expect(page.locator('text=Running')).toBeVisible();
    await expect(page.locator('text=2')).toBeVisible(); // 2 running agents
    await expect(page.locator('text=Idle')).toBeVisible();
    await expect(page.locator('text=1')).toBeVisible(); // 1 idle agent

    // Check agent list is populated
    await expect(page.locator('text=agent_health_check.sh')).toBeVisible();
    await expect(page.locator('text=running')).toBeVisible();
    await expect(page.locator('text=code_review_agent.sh')).toBeVisible();
    await expect(page.locator('text=idle')).toBeVisible();
    await expect(page.locator('text=performance_monitor.sh')).toBeVisible();
    await expect(page.locator('text=error')).toBeVisible();
  });

  test('displays task analytics with chart', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Check task metrics
    await expect(page.locator('text=Total Tasks')).toBeVisible();
    await expect(page.locator('text=1,250')).toBeVisible();
    await expect(page.locator('text=Success Rate')).toBeVisible();
    await expect(page.locator('text=96.7%')).toBeVisible();
    await expect(page.locator('text=Avg Duration')).toBeVisible();
    await expect(page.locator('text=2.3s')).toBeVisible();

    // Check chart canvas is present
    const taskChart = page.locator('#taskChart');
    await expect(taskChart).toBeVisible();
  });

  test('displays ML analytics', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Check ML metrics
    await expect(page.locator('text=Model Accuracy')).toBeVisible();
    await expect(page.locator('text=89.4%')).toBeVisible();
    await expect(page.locator('text=Predictions Made')).toBeVisible();
    await expect(page.locator('text=567')).toBeVisible();
    await expect(page.locator('text=Last Training')).toBeVisible();

    // Check ML chart is present
    const mlChart = page.locator('#mlChart');
    await expect(mlChart).toBeVisible();
  });

  test('displays Umami analytics overview', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Check analytics cards
    await expect(page.locator('text=Total Events')).toBeVisible();
    await expect(page.locator('text=15,420')).toBeVisible();
    await expect(page.locator('text=Unique Visitors')).toBeVisible();
    await expect(page.locator('text=892')).toBeVisible();
    await expect(page.locator('text=Page Views')).toBeVisible();
    await expect(page.locator('text=2,341')).toBeVisible();
    await expect(page.locator('text=Avg Session (min)')).toBeVisible();
    await expect(page.locator('text=4.7')).toBeVisible();
  });

  test('refresh button functionality', async ({ page }) => {
    await page.goto('/');

    // Wait for initial load
    await page.waitForTimeout(1000);

    // Click refresh button
    await page.click('text=ðŸ”„ Refresh Dashboard');

    // Wait for refresh to complete
    await page.waitForTimeout(1000);

    // Verify data is still displayed (refresh should work)
    await expect(page.locator('text=CPU Usage')).toBeVisible();
    await expect(page.locator('text=Agent Status')).toBeVisible();
  });

  test('handles server offline gracefully', async ({ page }) => {
    // Override routes to simulate server offline
    await page.route('http://localhost:5001/health', async route => {
      await route.fulfill({ status: 500 });
    });

    await page.route('http://localhost:5001/api/**', async route => {
      await route.fulfill({ status: 500 });
    });

    await page.goto('/');

    // Wait for error handling
    await page.waitForTimeout(2000);

    // Check server status shows error
    const serverStatus = page.locator('#server-status');
    await expect(serverStatus).toContainText('âŒ Not Running');

    // Check error messages are displayed
    await expect(page.locator('text=API server not running')).toBeVisible();
  });

  test('charts render correctly', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load and charts to render
    await page.waitForTimeout(2000);

    // Check all chart canvases are present and visible
    const performanceChart = page.locator('#performanceChart');
    const taskChart = page.locator('#taskChart');
    const mlChart = page.locator('#mlChart');

    await expect(performanceChart).toBeVisible();
    await expect(taskChart).toBeVisible();
    await expect(mlChart).toBeVisible();

    // Verify canvas elements have dimensions (indicating successful rendering)
    const perfBox = await performanceChart.boundingBox();
    const taskBox = await taskChart.boundingBox();
    const mlBox = await mlChart.boundingBox();

    expect(perfBox.width).toBeGreaterThan(0);
    expect(perfBox.height).toBeGreaterThan(0);
    expect(taskBox.width).toBeGreaterThan(0);
    expect(taskBox.height).toBeGreaterThan(0);
    expect(mlBox.width).toBeGreaterThan(0);
    expect(mlBox.height).toBeGreaterThan(0);
  });

  test('responsive design on mobile viewport', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 667 });

    await page.goto('/');

    // Wait for load
    await page.waitForTimeout(1000);

    // Check that dashboard still displays correctly
    await expect(page.locator('text=ðŸ¤– Agent Performance Dashboard')).toBeVisible();

    // Check that cards are still visible (should stack vertically on mobile)
    await expect(page.locator('text=ðŸ“Š System Performance')).toBeVisible();
    await expect(page.locator('text=âš™ï¸ Agent Status')).toBeVisible();
  });

  test('auto-refresh functionality', async ({ page }) => {
    await page.goto('/');

    // Wait for initial load
    await page.waitForTimeout(1000);

    // Get initial CPU usage value
    const initialCpuValue = page.locator('text=45.2%');

    // Wait for auto-refresh (30 seconds) - but we'll simulate it
    await page.waitForTimeout(31000);

    // Since we can't wait 30 seconds in tests, we'll just verify
    // the auto-refresh setup doesn't break anything
    await expect(page.locator('text=CPU Usage')).toBeVisible();
  });

  test('complete dashboard workflow - data loading to visualization', async ({ page }) => {
    await page.goto('/');

    // Step 1: Verify initial load
    await expect(page.locator('text=ðŸ¤– Agent Performance Dashboard')).toBeVisible();

    // Step 2: Check server connection
    await page.waitForTimeout(1000);
    const serverStatus = page.locator('#server-status');
    await expect(serverStatus).toContainText('âœ… Running');

    // Step 3: Verify all data sections load
    await expect(page.locator('text=CPU Usage')).toBeVisible();
    await expect(page.locator('text=Total Agents')).toBeVisible();
    await expect(page.locator('text=Total Tasks')).toBeVisible();
    await expect(page.locator('text=Model Accuracy')).toBeVisible();
    await expect(page.locator('text=Total Events')).toBeVisible();

    // Step 4: Test chart rendering
    const performanceChart = page.locator('#performanceChart');
    const taskChart = page.locator('#taskChart');
    const mlChart = page.locator('#mlChart');

    await expect(performanceChart).toBeVisible();
    await expect(taskChart).toBeVisible();
    await expect(mlChart).toBeVisible();

    // Step 5: Test refresh functionality
    await page.click('text=ðŸ”„ Refresh Dashboard');
    await page.waitForTimeout(1000);

    // Verify data persists after refresh
    await expect(page.locator('text=CPU Usage')).toBeVisible();
    await expect(page.locator('text=143')).toBeVisible(); // Active agents count
  });

  test('agent management workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for agent data to load
    await page.waitForTimeout(1000);

    // Verify agent status display
    await expect(page.locator('text=Total Agents')).toBeVisible();
    await expect(page.locator('text=Running')).toBeVisible();
    await expect(page.locator('text=Idle')).toBeVisible();

    // Check individual agent status
    await expect(page.locator('text=agent_health_check.sh')).toBeVisible();
    await expect(page.locator('text=running')).toBeVisible();
    await expect(page.locator('text=code_review_agent.sh')).toBeVisible();
    await expect(page.locator('text=idle')).toBeVisible();
    await expect(page.locator('text=performance_monitor.sh')).toBeVisible();
    await expect(page.locator('text=error')).toBeVisible();

    // Test agent status filtering (if implemented)
    // This would test filtering by status, but for now just verify display
  });

  test('task monitoring workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for task data to load
    await page.waitForTimeout(1000);

    // Verify task metrics
    await expect(page.locator('text=Total Tasks')).toBeVisible();
    await expect(page.locator('text=1,250')).toBeVisible();
    await expect(page.locator('text=Success Rate')).toBeVisible();
    await expect(page.locator('text=96.7%')).toBeVisible();
    await expect(page.locator('text=Avg Duration')).toBeVisible();
    await expect(page.locator('text=2.3s')).toBeVisible();

    // Verify task status breakdown
    await expect(page.locator('text=Completed')).toBeVisible();
    await expect(page.locator('text=Failed')).toBeVisible();
    await expect(page.locator('text=Running')).toBeVisible();

    // Test task chart interaction (hover, etc.)
    const taskChart = page.locator('#taskChart');
    await taskChart.hover();
    // Chart should remain visible after interaction
    await expect(taskChart).toBeVisible();
  });

  test('ML performance monitoring workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for ML data to load
    await page.waitForTimeout(1000);

    // Verify ML metrics
    await expect(page.locator('text=Model Accuracy')).toBeVisible();
    await expect(page.locator('text=89.4%')).toBeVisible();
    await expect(page.locator('text=Predictions Made')).toBeVisible();
    await expect(page.locator('text=567')).toBeVisible();
    await expect(page.locator('text=Last Training')).toBeVisible();

    // Verify ML chart
    const mlChart = page.locator('#mlChart');
    await expect(mlChart).toBeVisible();

    // Test chart data points
    await expect(page.locator('text=Execution Time')).toBeVisible();
    await expect(page.locator('text=Failure Rate')).toBeVisible();
    await expect(page.locator('text=Accuracy')).toBeVisible();
  });

  test('analytics dashboard workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for analytics data to load
    await page.waitForTimeout(1000);

    // Verify Umami analytics section
    await expect(page.locator('text=ðŸ“ˆ Umami Analytics Overview')).toBeVisible();

    // Check all analytics metrics
    await expect(page.locator('text=Total Events')).toBeVisible();
    await expect(page.locator('text=15,420')).toBeVisible();
    await expect(page.locator('text=Unique Visitors')).toBeVisible();
    await expect(page.locator('text=892')).toBeVisible();
    await expect(page.locator('text=Page Views')).toBeVisible();
    await expect(page.locator('text=2,341')).toBeVisible();
    await expect(page.locator('text=Avg Session (min)')).toBeVisible();
    await expect(page.locator('text=4.7')).toBeVisible();

    // Test analytics card layout
    const analyticsCards = page.locator('.analytics-card');
    await expect(analyticsCards).toHaveCount(4); // Should have 4 analytics cards
  });

  test('system performance monitoring workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for system data to load
    await page.waitForTimeout(1000);

    // Verify system metrics
    await expect(page.locator('text=CPU Usage')).toBeVisible();
    await expect(page.locator('text=45.2%')).toBeVisible();
    await expect(page.locator('text=Memory Usage')).toBeVisible();
    await expect(page.locator('text=62.8%')).toBeVisible();
    await expect(page.locator('text=Disk Usage')).toBeVisible();
    await expect(page.locator('text=78.3%')).toBeVisible();
    await expect(page.locator('text=Active Agents')).toBeVisible();
    await expect(page.locator('text=143')).toBeVisible();

    // Verify performance chart
    const performanceChart = page.locator('#performanceChart');
    await expect(performanceChart).toBeVisible();

    // Test chart data series
    await expect(page.locator('text=CPU Usage (%)')).toBeVisible();
    await expect(page.locator('text=Memory Usage (%)')).toBeVisible();
  });

  test('error handling and recovery workflow', async ({ page }) => {
    // Test server offline scenario
    await page.route('http://localhost:5001/health', async route => {
      await route.fulfill({ status: 500 });
    });

    await page.route('http://localhost:5001/api/**', async route => {
      await route.fulfill({ status: 500 });
    });

    await page.goto('/');

    // Wait for error handling
    await page.waitForTimeout(2000);

    // Verify error state display
    const serverStatus = page.locator('#server-status');
    await expect(serverStatus).toContainText('âŒ Not Running');

    // Check error messages in all sections
    await expect(page.locator('text=API server not running')).toBeVisible();

    // Test recovery - restore routes
    await page.route('http://localhost:5001/health', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({ status: 'healthy', uptime: 3600 })
      });
    });

    await page.route('http://localhost:5001/api/metrics/system', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          cpu_usage: 30.0,
          memory_usage: 45.0,
          disk_usage: 60.0,
          agent_count: 143
        })
      });
    });

    // Trigger refresh
    await page.click('text=ðŸ”„ Refresh Dashboard');
    await page.waitForTimeout(1000);

    // Verify recovery
    await expect(page.locator('#server-status')).toContainText('âœ… Running');
    await expect(page.locator('text=CPU Usage')).toBeVisible();
  });

  test('data export and sharing workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for data to load
    await page.waitForTimeout(1000);

    // Test that all data is visible for potential export
    await expect(page.locator('text=45.2%')).toBeVisible(); // CPU
    await expect(page.locator('text=143')).toBeVisible(); // Agents
    await expect(page.locator('text=1,250')).toBeVisible(); // Tasks
    await expect(page.locator('text=89.4%')).toBeVisible(); // ML Accuracy
    await expect(page.locator('text=15,420')).toBeVisible(); // Events

    // Test page is printable (for PDF export)
    const hasPrintStyles = await page.evaluate(() => {
      const styles = document.querySelectorAll('style, link[rel="stylesheet"]');
      return styles.length > 0;
    });
    expect(hasPrintStyles).toBe(true);
  });

  test('accessibility and usability workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for load
    await page.waitForTimeout(1000);

    // Test keyboard navigation
    await page.keyboard.press('Tab');
    await page.keyboard.press('Tab');

    // Test that interactive elements are focusable
    const refreshButton = page.locator('text=ðŸ”„ Refresh Dashboard');
    await expect(refreshButton).toBeVisible();

    // Test color contrast (basic check - elements should be visible)
    const header = page.locator('text=ðŸ¤– Agent Performance Dashboard');
    const headerColor = await header.evaluate(el => getComputedStyle(el).color);
    expect(headerColor).not.toBe('rgba(0, 0, 0, 0)'); // Should have color

    // Test responsive text sizing
    const isMobile = await page.evaluate(() => window.innerWidth < 768);
    if (isMobile) {
      // On mobile, text should still be readable
      const headerBox = await header.boundingBox();
      expect(headerBox.height).toBeGreaterThan(20);
    }
  });

  test('real-time updates workflow', async ({ page }) => {
    await page.goto('/');

    // Wait for initial load
    await page.waitForTimeout(1000);

    // Get initial values
    const initialCpu = page.locator('text=45.2%');
    const initialTasks = page.locator('text=1,250');

    await expect(initialCpu).toBeVisible();
    await expect(initialTasks).toBeVisible();

    // Simulate data change by updating routes
    await page.route('http://localhost:5001/api/metrics/system', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          cpu_usage: 55.0, // Changed from 45.2
          memory_usage: 62.8,
          disk_usage: 78.3,
          agent_count: 143
        })
      });
    });

    await page.route('http://localhost:5001/api/tasks/analytics', async route => {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          total_tasks: 1350, // Changed from 1250
          success_rate: 0.967,
          avg_duration: 2.3,
          completed: 1309,
          failed: 41,
          running: 12
        })
      });
    });

    // Trigger refresh
    await page.click('text=ðŸ”„ Refresh Dashboard');
    await page.waitForTimeout(1000);

    // Verify updated values
    await expect(page.locator('text=55.0%')).toBeVisible();
    await expect(page.locator('text=1,350')).toBeVisible();
  });

  test('cross-browser compatibility workflow', async ({ page }) => {
    // This test ensures the dashboard works across different browser contexts
    await page.goto('/');

    // Wait for load
    await page.waitForTimeout(1000);

    // Test that all modern web APIs are available
    const apisAvailable = await page.evaluate(() => {
      return {
        fetch: typeof fetch !== 'undefined',
        json: typeof JSON !== 'undefined',
        promise: typeof Promise !== 'undefined',
        canvas: typeof HTMLCanvasElement !== 'undefined'
      };
    });

    expect(apisAvailable.fetch).toBe(true);
    expect(apisAvailable.json).toBe(true);
    expect(apisAvailable.promise).toBe(true);
    expect(apisAvailable.canvas).toBe(true);

    // Test that charts render (canvas API working)
    const performanceChart = page.locator('#performanceChart');
    const chartRendered = await performanceChart.evaluate(canvas => {
      const ctx = canvas.getContext('2d');
      return ctx !== null;
    });
  });

    expect(chartRendered).toBe(true);
});
